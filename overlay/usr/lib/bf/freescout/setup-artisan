#!/usr/bin/with-contenv bash

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# If an existing installation was detected, do not proceed.
#======================================================================================================================

if [ "${FREESCOUT_INSTALLED}" = "1" ] ; then
    bf-echo "Existing installation detected - do not run artisan setup."
    exit 0
fi


#======================================================================================================================
# Run artisan setup routines.
#======================================================================================================================

cd ${FREESCOUT_SRC}

bf-debug "Generate key."
php artisan key:generate

bf-debug "Clear cache."
php artisan freescout:clear-cache
php artisan config:clear

bf-debug "Link storage."
php artisan storage:link

bf-debug "Migrate database."
php artisan migrate --force

bf-debug "Create admin user."
php artisan -n freescout:create-user \
    --role=admin \
    --firstName="${FREESCOUT_ADMIN_FIRSTNAME}" \
    --lastName="${FREESCOUT_ADMIN_LASTNAME}" \
    --email="${FREESCOUT_ADMIN_EMAIL}" \
    --password="${FREESCOUT_ADMIN_PASS}"

bf-done
